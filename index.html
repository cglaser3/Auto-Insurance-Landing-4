<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto Insurance Quote</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div id="root" class="w-full max-w-2xl p-4"></div>

  <script type="text/javascript">
    const { useState } = React;

    const years = Array.from({ length: 2025 - 1981 + 1 }, (_, i) => 2025 - i);

    const initialDriver = { fullName: '', dob: '', license: '' };
    const initialVehicle = { year: '', make: '', model: '', vin: '' };
    const initialCoverage = { type: 'Liability', deductible: '500' };

    function InsuranceForm() {
      const [step, setStep] = useState(1);
      const [formData, setFormData] = useState({
        contact: {
          firstName: '', lastName: '', email: '', phone: '',
          address: { street: '', city: '', state: '', zip: '' }
        },
        drivers: [ { ...initialDriver } ],
        vehicles: [ { ...initialVehicle } ],
        insurance: {
          insurer: '', timeInsured: '', coverageLimits: '25,000/50,000',
          vehicleCoverage: [ { ...initialCoverage } ],
          premium: ''
        }
      });
      const [makes, setMakes] = useState([]);
      const [models, setModels] = useState([]);
      const [loading, setLoading] = useState(false);

      const updateField = (section, index, field, value) => {
        setFormData(prev => {
          const data = { ...prev };
          if (section === 'contact') {
            if (field in data.contact.address) {
              data.contact.address[field] = value;
            } else {
              data.contact[field] = value;
            }
          } else if (section === 'drivers') {
            data.drivers[index][field] = value;
          } else if (section === 'vehicles') {
            data.vehicles[index][field] = value;
          } else if (section === 'insurance') {
            if (field === 'vehicleCoverage') {
              data.insurance.vehicleCoverage[index] = {
                ...data.insurance.vehicleCoverage[index], ...value
              };
            } else {
              data.insurance[field] = value;
            }
          }
          return data;
        });
      };

      const setDriverCount = count => {
        setFormData(prev => ({
          ...prev,
          drivers: Array.from({ length: count }, (_, i) => prev.drivers[i] || { ...initialDriver })
        }));
      };

      const setVehicleCount = count => {
        setFormData(prev => ({
          ...prev,
          vehicles: Array.from({ length: count }, (_, i) => prev.vehicles[i] || { ...initialVehicle }),
          insurance: {
            ...prev.insurance,
            vehicleCoverage: Array.from({ length: count }, (_, i) => prev.insurance.vehicleCoverage[i] || { ...initialCoverage })
          }
        }));
      };

      const fetchMakes = async () => {
        setLoading(true);
        try {
          const res = await fetch('https://vpic.nhtsa.dot.gov/api/vehicles/GetMakesForVehicleType/passenger%20car?format=json');
          const data = await res.json();
          setMakes(data.Results.map(m => m.Make_Name));
        } catch(e) {
          console.error('Failed to fetch makes');
        }
        setLoading(false);
      };

      const fetchModels = async (make, year) => {
        if(!make || !year) return;
        setLoading(true);
        try {
          const res = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/GetModelsForMakeYear/make/${make}/modelyear/${year}?format=json`);
          const data = await res.json();
          setModels(data.Results.map(m => m.Model_Name));
        } catch(e) {
          console.error('Failed to fetch models');
        }
        setLoading(false);
      };

      const decodeVin = async (vin, index) => {
        if(!vin) return;
        setLoading(true);
        try {
          const res = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/${vin}?format=json`);
          const data = await res.json();
          const info = data.Results[0];
          updateField('vehicles', index, 'year', info.ModelYear || '');
          updateField('vehicles', index, 'make', info.Make || '');
          updateField('vehicles', index, 'model', info.Model || '');
        } catch(e) {
          console.error('VIN decode failed');
        }
        setLoading(false);
      };

      const validStep = () => {
        if(step === 1) {
          const c = formData.contact;
          const a = c.address;
          return c.firstName && c.lastName && /\S+@\S+\.\S+/.test(c.email) && /^\d{10}$/.test(c.phone) && a.street && a.city && a.state && a.zip;
        }
        if(step === 2) {
          return formData.drivers.every(d => d.fullName && d.dob);
        }
        if(step === 3) {
          return formData.vehicles.every(v => v.year && v.make && v.model);
        }
        if(step === 4) {
          return true;
        }
        return true;
      };

      const next = () => { if(validStep() && step < 5) setStep(s => s+1); };
      const prev = () => { if(step > 1) setStep(s => s-1); };

      const renderStep = () => {
        if(step === 1) {
          const c = formData.contact;
          const a = c.address;
          return (
            <div className="space-y-4">
              <h2 className="text-xl font-semibold">Contact Information</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input className="border p-2 rounded" placeholder="First Name" value={c.firstName} onChange={e=>updateField('contact',0,'firstName',e.target.value)} required />
                <input className="border p-2 rounded" placeholder="Last Name" value={c.lastName} onChange={e=>updateField('contact',0,'lastName',e.target.value)} required />
                <input className="border p-2 rounded md:col-span-2" placeholder="Email" type="email" value={c.email} onChange={e=>updateField('contact',0,'email',e.target.value)} required />
                <input className="border p-2 rounded md:col-span-2" placeholder="Phone (10 digits)" type="tel" value={c.phone} onChange={e=>updateField('contact',0,'phone',e.target.value.replace(/[^\d]/g,''))} required />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input className="border p-2 rounded md:col-span-2" placeholder="Street" value={a.street} onChange={e=>updateField('contact',0,'street',e.target.value)} required />
                <input className="border p-2 rounded" placeholder="City" value={a.city} onChange={e=>updateField('contact',0,'city',e.target.value)} required />
                <input className="border p-2 rounded" placeholder="State" value={a.state} onChange={e=>updateField('contact',0,'state',e.target.value)} required />
                <input className="border p-2 rounded" placeholder="ZIP" value={a.zip} onChange={e=>updateField('contact',0,'zip',e.target.value)} required />
              </div>
            </div>
          );
        }
        if(step === 2) {
          return (
            <div className="space-y-4">
              <h2 className="text-xl font-semibold">Driver Details</h2>
              <div>
                <label className="mr-2">How many drivers?</label>
                <select value={formData.drivers.length} onChange={e=>setDriverCount(Number(e.target.value))} className="border p-1 rounded">
                  {[1,2,3,4,5].map(n=><option key={n} value={n}>{n}</option>)}
                </select>
              </div>
              {formData.drivers.map((d,i)=>(
                <div key={i} className="border-t pt-4 mt-4 space-y-2">
                  <h3 className="font-medium">Driver {i+1}</h3>
                  <input className="border p-2 rounded w-full" placeholder="Full Name" value={d.fullName} onChange={e=>updateField('drivers',i,'fullName',e.target.value)} required />
                  <input className="border p-2 rounded w-full" type="date" value={d.dob} onChange={e=>updateField('drivers',i,'dob',e.target.value)} required />
                  <input className="border p-2 rounded w-full" placeholder="License # (optional)" value={d.license} onChange={e=>updateField('drivers',i,'license',e.target.value)} />
                </div>
              ))}
            </div>
          );
        }
        if(step === 3) {
          return (
            <div className="space-y-4">
              <h2 className="text-xl font-semibold">Vehicle Information</h2>
              <div>
                <label className="mr-2">How many vehicles?</label>
                <select value={formData.vehicles.length} onChange={e=>setVehicleCount(Number(e.target.value))} className="border p-1 rounded">
                  {[1,2,3,4,5].map(n=><option key={n} value={n}>{n}</option>)}
                </select>
              </div>
              {formData.vehicles.map((v,i)=>(
                <div key={i} className="border-t pt-4 mt-4 space-y-2">
                  <h3 className="font-medium">Vehicle {i+1}</h3>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <select className="border p-2 rounded" value={v.year} onChange={e=>{updateField('vehicles',i,'year',e.target.value); fetchMakes();}} required>
                      <option value="">Year</option>
                      {years.map(y=><option key={y} value={y}>{y}</option>)}
                    </select>
                    <select className="border p-2 rounded" value={v.make} onChange={e=>{updateField('vehicles',i,'make',e.target.value); fetchModels(e.target.value,v.year);}} required>
                      <option value="">{loading? 'Loading...' : 'Make'}</option>
                      {makes.map(m=><option key={m} value={m}>{m}</option>)}
                    </select>
                    <select className="border p-2 rounded" value={v.model} onChange={e=>updateField('vehicles',i,'model',e.target.value)} required>
                      <option value="">{loading? 'Loading...' : 'Model'}</option>
                      {models.map(mo=><option key={mo} value={mo}>{mo}</option>)}
                    </select>
                  </div>
                  <div className="flex space-x-2">
                    <input className="border p-2 rounded flex-1" placeholder="VIN (optional)" value={v.vin} onChange={e=>updateField('vehicles',i,'vin',e.target.value)} />
                    <button type="button" className="px-3 py-2 bg-blue-500 text-white rounded" onClick={()=>decodeVin(v.vin,i)}>Decode</button>
                  </div>
                </div>
              ))}
            </div>
          );
        }
        if(step === 4) {
          const ins = formData.insurance;
          return (
            <div className="space-y-4">
              <h2 className="text-xl font-semibold">Current Insurance</h2>
              <input className="border p-2 rounded w-full" placeholder="Current Insurer" value={ins.insurer} onChange={e=>updateField('insurance',0,'insurer',e.target.value)} />
              <select className="border p-2 rounded w-full" value={ins.timeInsured} onChange={e=>updateField('insurance',0,'timeInsured',e.target.value)} required>
                <option value="">Time insured with them</option>
                <option value="<6 months">&lt;6 months</option>
                <option value="6-12 months">6–12 months</option>
                <option value="1-3 years">1–3 years</option>
                <option value="3+ years">3+ years</option>
              </select>
              <select className="border p-2 rounded w-full" value={ins.coverageLimits} onChange={e=>updateField('insurance',0,'coverageLimits',e.target.value)} required>
                <option value="25,000/50,000">25,000/50,000</option>
                <option value="50,000/100,000">50,000/100,000</option>
                <option value="100,000/300,000">100,000/300,000</option>
                <option value=">100,000/300,000">Greater than 100,000/300,000</option>
              </select>
              {formData.vehicles.map((v,i)=>(
                <div key={i} className="border-t pt-4 mt-4">
                  <h3 className="font-medium">Coverage for Vehicle {i+1}</h3>
                  <select className="border p-2 rounded w-full" value={ins.vehicleCoverage[i].type} onChange={e=>updateField('insurance',i,'vehicleCoverage',{type: e.target.value})} required>
                    <option value="Full">Full</option>
                    <option value="Liability">Liability</option>
                  </select>
                  {ins.vehicleCoverage[i].type === 'Full' && (
                    <select className="border p-2 rounded w-full mt-2" value={ins.vehicleCoverage[i].deductible} onChange={e=>updateField('insurance',i,'vehicleCoverage',{deductible: e.target.value})} required>
                      <option value="250">250</option>
                      <option value="500">500</option>
                      <option value="1000">1000</option>
                    </select>
                  )}
                </div>
              ))}
              <input className="border p-2 rounded w-full" placeholder="Current Premium (optional)" value={ins.premium} onChange={e=>updateField('insurance',0,'premium',e.target.value)} />
            </div>
          );
        }
        return (
          <div className="text-center py-10">
            <h2 className="text-xl font-semibold mb-4">Thanks! Your quote will be emailed to you within 30 minutes.</h2>
          </div>
        );
      };

      return (
        <form className="bg-white p-6 rounded shadow-md space-y-6">
          <div className="text-sm text-gray-600 text-right">Step {step} of 5</div>
          {renderStep()}
          <div className="flex justify-between pt-4">
            {step > 1 && <button type="button" onClick={prev} className="px-4 py-2 rounded bg-gray-200">Back</button>}
            {step < 5 && <button type="button" onClick={next} disabled={!validStep()} className="px-4 py-2 rounded bg-blue-500 text-white disabled:opacity-50">Next</button>}
          </div>
        </form>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<InsuranceForm />);
  </script>
</body>
</html>
